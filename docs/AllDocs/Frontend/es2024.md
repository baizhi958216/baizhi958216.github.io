# ECMAScript 2024 (15)

ArrayBufferå’ŒSharedArrayBufferæ–°å¢å¯è°ƒæ•´å¤§å°é€‰é¡¹

æ­£åˆ™è¡¨è¾¾å¼æ–°å¢`/v`ï¼Œç”¨äºåˆ›å»ºå…·æœ‰æ›´é«˜çº§åŠŸèƒ½çš„æ­£åˆ™è¡¨è¾¾å¼æ¥å¤„ç†å­—ç¬¦ä¸²é›†åˆ

Promiseæ–°å¢withResolversæ¥æ„å»ºPromises

Objectå’ŒMapæ–°å¢groupByç”¨äºèšåˆæ•°æ®

Atomicsæ–°å¢waitAsyncæ–¹æ³•ç”¨äºå¼‚æ­¥ç­‰å¾…å…±äº«å†…å­˜çš„æ›´æ”¹

Stringæ–°å¢isWellFormedå’ŒtoWellFormedæ¥æ£€æŸ¥å’Œç¡®ä¿å­—ç¬¦ä¸²ä»…åŒ…å«æ­£å¸¸çš„Unicodeå­—ç¬¦

## ç‰¹æ€§ä¸€è§ˆ

- [ArrayBufferå’ŒSharedArrayBuffer](#arraybufferå’Œsharedarraybuffer)
- [æ­£åˆ™è¡¨è¾¾å¼æ–°å¢`/v`](#æ­£åˆ™è¡¨è¾¾å¼æ–°å¢-v)
- [Promiseæ–°å¢withResolvers](#promiseæ–°å¢withresolvers)
- [Objectå’ŒMapæ–°å¢groupBy](#objectå’Œmapæ–°å¢groupby)
- [Atomicsæ–°å¢waitAsync](#atomicsæ–°å¢waitasync)
- [Stringæ–°å¢isWellFormedå’ŒtoWellFormed](#stringæ–°å¢iswellformedå’Œtowellformed)

## ArrayBufferå’ŒSharedArrayBuffer

å¯è°ƒæ•´å¤§å°çš„ArrayBufferé€šè¿‡è°ƒç”¨`ArrayBuffer.prototype.resize()`å¯ä»¥æ›´æ”¹å…¶å­—èŠ‚é•¿åº¦ã€‚

```js
const buffer = new ArrayBuffer(8, { maxByteLength: 16 });

console.log(buffer.byteLength);
// Expected output: 8

buffer.resize(12);

console.log(buffer.byteLength);
// Expected output: 12
```

å¯è°ƒæ•´å¤§å°çš„SharedArrayBufferé€šè¿‡è°ƒç”¨`SharedArrayBuffer.prototype.grow()`å¯ä»¥æ›´æ”¹å…¶å­—èŠ‚é•¿åº¦ã€‚

```js
const buffer = new SharedArrayBuffer(8, { maxByteLength: 16 });

console.log(buffer.byteLength);

buffer.grow(12);

console.log(buffer.byteLength);
```

## æ­£åˆ™è¡¨è¾¾å¼æ–°å¢`/v`

è¿™ç§æ–°æ¨¡å¼æ–°å¢äº†å¯¹æ‰©å±•å­—ç¬¦ç±»çš„æ”¯æŒï¼ŒåŒ…æ‹¬ä»¥ä¸‹åŠŸèƒ½ï¼š

- å­—ç¬¦ä¸²çš„ Unicode å±æ€§
- é›†åˆè¡¨ç¤ºæ³•+å­—ç¬¦ä¸²æ–‡å­—è¯­æ³•
- åŒ¹é…ä¸åŒºåˆ†å¤§å°å†™çš„è¯­æ³•

```js
// Unicode defines a character property named â€œEmojiâ€.
const re1 = /^\p{Emoji}$/u;

// Match an emoji that consists of multiple code points:
re1.test('ğŸ‘¨ğŸ¾â€âš•ï¸'); // '\u{1F468}\u{1F3FE}\u200D\u2695\uFE0F'
// â†’ false âŒ

const re2 = /^\p{RGI_Emoji}$/v;

// Match an emoji that consists of multiple code points:
re2.test('ğŸ‘¨ğŸ¾â€âš•ï¸'); // '\u{1F468}\u{1F3FE}\u200D\u2695\uFE0F'
// â†’ true âœ…
```

## Promiseæ–°å¢withResolvers

`withResolvers`çš„ç›®çš„æ˜¯ç®€åŒ–ä» `Promise` ä¸­æå– `resolve` å’Œ `reject`ã€‚

```js
const { promise, resolve, reject } = Promise.withResolvers();

promise.then(res => {
  console.log(res)
})

let a = 10

if(a===10){
  resolve(10)
}else{
  reject(0)
}
```

## Objectå’ŒMapæ–°å¢groupBy

ç”¨æ¥ç»™å®šå¯è¿­ä»£å¯¹è±¡ä¸­çš„å…ƒç´ è¿›è¡Œåˆ†ç»„ã€‚

```js
const inventory = [
  { name: "asparagus", type: "vegetables", quantity: 5 },
  { name: "bananas", type: "fruit", quantity: 0 },
  { name: "goat", type: "meat", quantity: 23 },
  { name: "cherries", type: "fruit", quantity: 5 },
  { name: "fish", type: "meat", quantity: 22 },
];

const result1 = Object.groupBy(inventory, ({ type }) => type);
/*
{
  vegetables: [ { name: 'asparagus', type: 'vegetables', quantity: 5 } ],
  fruit: [
    { name: 'bananas', type: 'fruit', quantity: 0 },
    { name: 'cherries', type: 'fruit', quantity: 5 }
  ],
  meat: [
    { name: 'goat', type: 'meat', quantity: 23 },
    { name: 'fish', type: 'meat', quantity: 22 }
  ]
}
*/

const result2 = Map.groupBy(inventory, ({ type }) => type);

/*
{
  'vegetables' => [ { name: 'asparagus', type: 'vegetables', quantity: 5 } ],
  'fruit' => [
    { name: 'bananas', type: 'fruit', quantity: 0 },
    { name: 'cherries', type: 'fruit', quantity: 5 }
  ],
  'meat' => [
    { name: 'goat', type: 'meat', quantity: 23 },
    { name: 'fish', type: 'meat', quantity: 22 }
  ]
}
*/
```

## Atomicsæ–°å¢waitAsync

å¼‚æ­¥ç­‰å¾…å…±äº«å†…å­˜çš„ç‰¹å®šä½ç½®å¹¶è¿”å›ä¸€ä¸ª`Promise`ï¼Œæ˜¯éé˜»å¡çš„ä¸”å¯ç”¨äºä¸»çº¿ç¨‹ã€‚

ç»™å®šä¸€ä¸ªå…±äº«çš„ Int32Arrayã€‚

```js
const sab = new SharedArrayBuffer(1024);
const int32 = new Int32Array(sab);
```

ä»¤ä¸€ä¸ªè¯»å–çº¿ç¨‹ä¼‘çœ å¹¶åœ¨ä½ç½® 0 å¤„ç­‰å¾…ï¼Œé¢„æœŸè¯¥ä½ç½®çš„å€¼ä¸º 0ã€‚result.value å°†æ˜¯ä¸€ä¸ª promiseã€‚

```js
const result = Atomics.waitAsync(int32, 0, 0, 1000);
// { async: true, value: Promise {<pending>} }
```

åœ¨è¯¥è¯»å–çº¿ç¨‹æˆ–å¦ä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œå¯¹å†…å­˜ä½ç½® 0 è°ƒç”¨ä»¥ä»¤è¯¥ promise è§£å†³ä¸º "ok"ã€‚

```js
Atomics.notify(int32, 0);
// { async: true, value: Promise {<fulfilled>: 'ok'} }
```
å¦‚æœå®ƒæ²¡æœ‰è§£å†³ä¸º "ok"ï¼Œåˆ™å…±äº«å†…å­˜è¯¥ä½ç½®çš„å€¼ä¸ç¬¦åˆé¢„æœŸï¼ˆvalue å°†æ˜¯ "not-equal" è€Œä¸æ˜¯ä¸€ä¸ª promiseï¼‰æˆ–å·²ç»è¶…æ—¶ï¼ˆè¯¥ promise å°†è§£å†³ä¸º "time-out"ï¼‰ã€‚

## Stringæ–°å¢isWellFormedå’ŒtoWellFormed

`isWellFormed()`è¿”å›ä¸€ä¸ªè¡¨ç¤ºè¯¥å­—ç¬¦ä¸²æ˜¯å¦åŒ…å«å•ç‹¬ä»£ç†é¡¹çš„å¸ƒå°”å€¼ã€‚

```js
console.log("\uDFFFab".isWellFormed())
// false
console.log("abc".isWellFormed())
// true
```

toWellFormed() æ–¹æ³•è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå…¶ä¸­è¯¥å­—ç¬¦ä¸²çš„æ‰€æœ‰å•ç‹¬ä»£ç†é¡¹éƒ½è¢«æ›¿æ¢ä¸º Unicode æ›¿æ¢å­—ç¬¦ U+FFFDã€‚

```js
const strings = [
  // å•ç‹¬çš„å‰å¯¼ä»£ç†
  "ab\uD800",
  "ab\uD800c",
  // å•ç‹¬çš„åå°¾ä»£ç†
  "\uDFFFab",
  "c\uDFFFab",
  // æ ¼å¼æ­£ç¡®
  "abc",
  "ab\uD83D\uDE04c",
];

for (const str of strings) {
  console.log(str.toWellFormed());
}

// "abï¿½"
// "abï¿½c"
// "ï¿½ab"
// "cï¿½ab"
// "abc"
// "abğŸ˜„c"
```